import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { ArrowLeft, Headphones, Play, Pause, Volume2, Settings, Download, Clock } from 'lucide-react';

interface ListeningSection {
  id: number;
  title: string;
  description: string;
  audio_script: string;
  questions: Array<{
    id: number;
    question: string;
    type: 'multiple_choice' | 'fill_in_blank' | 'true_false' | 'matching' | 'form_completion' | 'note_completion' | 'sentence_completion';
    options?: string[];
    correct_answer: number | string | boolean;
    word_limit?: number;
  }>;
  duration: number; // dakika
}

interface ListeningContent {
  sections: ListeningSection[];
  total_questions: number;
  total_duration: number; // dakika
  topic: string;
  difficulty: string;
  instructions: string;
}

interface TTSResponse {
  message: string;
  duration: number;
  status: string;
  audio_data?: string; // Base64 encoded audio
}

const ListeningModule: React.FC = () => {
  const [listeningContent, setListeningContent] = useState<ListeningContent | null>(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  const [isGeneratingAudio, setIsGeneratingAudio] = useState(false);
  const [currentAudio, setCurrentAudio] = useState<HTMLAudioElement | null>(null);
  const [selectedTopic, setSelectedTopic] = useState('Education');
  const [selectedDifficulty, setSelectedDifficulty] = useState('intermediate');
  const [selectedAccent, setSelectedAccent] = useState('british');
  const [userAnswers, setUserAnswers] = useState<{ [key: number]: number | string | boolean }>({});
  const [showResults, setShowResults] = useState(false);
  const [score, setScore] = useState(0);
  const [showTranscript, setShowTranscript] = useState(false);
  const [currentSection, setCurrentSection] = useState(0);
  const [testStarted, setTestStarted] = useState(false);
  const [timeLeft, setTimeLeft] = useState(0);
  const [isPaused, setIsPaused] = useState(false);

  const topics = [
    'Education', 'Work', 'Travel', 'Health', 'Technology', 'Environment'
  ];

  const difficulties = [
    { value: 'beginner', label: 'Ba≈ülangƒ±√ß' },
    { value: 'intermediate', label: 'Orta' },
    { value: 'advanced', label: 'ƒ∞leri' }
  ];

  const accents = [
    { value: 'british', label: 'üá¨üáß ƒ∞ngiliz (Adam - Doƒüal)' },
    { value: 'american', label: 'üá∫üá∏ Amerikan (Bella - Doƒüal)' },
    { value: 'australian', label: 'üá¶üá∫ Avustralya (Arnold - Doƒüal)' }
  ];

  const generateListening = async () => {
    setIsGenerating(true);
    try {
      const response = await fetch('http://localhost:8003/generate-ielts-listening', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          topic: selectedTopic,
          difficulty: selectedDifficulty,
          accent: selectedAccent
        }),
      });

      if (response.ok) {
        const data = await response.json();
        setListeningContent(data);
        setUserAnswers({});
        setShowResults(false);
        setShowTranscript(false);
        setCurrentSection(0);
        setTestStarted(false);
        setTimeLeft(data.total_duration * 60); // dakikayƒ± saniyeye √ßevir
      } else {
        alert('Listening i√ßeriƒüi olu≈üturulamadƒ±!');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Baƒülantƒ± hatasƒ±!');
    } finally {
      setIsGenerating(false);
    }
  };

  const stopAudio = () => {
    if (currentAudio) {
      currentAudio.pause();
      // currentTime = 0 kaldƒ±rdƒ±k, kaldƒ±ƒüƒ± yerden devam etsin
      setCurrentAudio(null);
    }
    setIsPlaying(false);
  };

  const playText = async (text: string) => {
    // Eƒüer zaten √ßalƒ±yorsa durdur
    if (isPlaying) {
      stopAudio();
      return;
    }

    // Eƒüer ses zaten y√ºklenmi≈üse, kaldƒ±ƒüƒ± yerden devam et
    if (currentAudio && currentAudio.paused) {
      currentAudio.play();
      setIsPlaying(true);
      return;
    }

    setIsGeneratingAudio(true);
    try {
      // √ñnce ElevenLabs TTS'i dene (en doƒüal ses)
      let response = await fetch('http://localhost:8003/elevenlabs-tts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: text,
          accent: selectedAccent,
          speed: 1.0
        }),
      });

      if (response.ok) {
        const data: TTSResponse = await response.json();
        console.log('ElevenLabs TTS Response:', data);
        
        // Eƒüer audio_data varsa, ses dosyasƒ±nƒ± oynat
        if (data.audio_data) {
          const audioBlob = new Blob([Uint8Array.from(atob(data.audio_data), c => c.charCodeAt(0))], { type: 'audio/mp3' });
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          setCurrentAudio(audio);
          
          audio.onended = () => {
            URL.revokeObjectURL(audioUrl);
            setCurrentAudio(null);
            setIsPlaying(false);
          };

          audio.onerror = () => {
            URL.revokeObjectURL(audioUrl);
            setCurrentAudio(null);
            setIsPlaying(false);
            alert('Ses oynatƒ±lƒ±rken hata olu≈ütu!');
          };

          await audio.play();
          setIsGeneratingAudio(false);
          setIsPlaying(true);
        } else {
          setIsGeneratingAudio(false);
        }
      } else {
        // ElevenLabs TTS √ßalƒ±≈ümazsa, Enhanced TTS'e geri d√∂n
        response = await fetch('http://localhost:8003/enhanced-tts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: text,
            accent: selectedAccent,
            speed: 1.0
          }),
        });

        if (response.ok) {
          const data: TTSResponse = await response.json();
          console.log('Enhanced TTS Response:', data);
        } else {
          alert('Ses oynatƒ±lamadƒ±!');
        }
        setIsGeneratingAudio(false);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Baƒülantƒ± hatasƒ±!');
      setIsGeneratingAudio(false);
    }
  };

  const handleAnswerSelect = (questionId: number, answer: number | string | boolean) => {
    setUserAnswers(prev => ({
      ...prev,
      [questionId]: answer
    }));
  };

  // Timer effect
  useEffect(() => {
    let interval: NodeJS.Timeout;
    
    if (testStarted && !isPaused && timeLeft > 0) {
      interval = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 1) {
            // S√ºre bitti
            setTestStarted(false);
            checkAnswers();
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }

    return () => clearInterval(interval);
  }, [testStarted, isPaused, timeLeft]);

  const startTest = () => {
    setTestStarted(true);
    setIsPaused(false);
  };

  const pauseTest = () => {
    setIsPaused(!isPaused);
  };

  const formatTime = (seconds: number) => {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  };

  const nextSection = () => {
    if (listeningContent && currentSection < listeningContent.sections.length - 1) {
      setCurrentSection(currentSection + 1);
    }
  };

  const prevSection = () => {
    if (currentSection > 0) {
      setCurrentSection(currentSection - 1);
    }
  };

  const checkAnswers = () => {
    if (!listeningContent) return;

    let correctCount = 0;
    let totalQuestions = 0;

    listeningContent.sections.forEach(section => {
      section.questions.forEach(question => {
        totalQuestions++;
        const userAnswer = userAnswers[question.id];
        const correctAnswer = question.correct_answer;
        
        // Farklƒ± soru tiplerini kontrol et
        if (question.type === 'fill_in_blank' || question.type === 'form_completion' || 
            question.type === 'note_completion' || question.type === 'sentence_completion') {
          // Bo≈üluk doldurma i√ßin case-insensitive kar≈üƒ±la≈ütƒ±rma
          if (typeof userAnswer === 'string' && typeof correctAnswer === 'string') {
            if (userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim()) {
              correctCount++;
            }
          }
        } else {
          // Multiple choice, true/false, matching i√ßin normal kar≈üƒ±la≈ütƒ±rma
          if (userAnswer === correctAnswer) {
            correctCount++;
          }
        }
      });
    });

    const calculatedScore = Math.round((correctCount / totalQuestions) * 100);
    setScore(calculatedScore);
    setShowResults(true);
    setTestStarted(false);
  };

  return (
    <div className="container">
      <div className="card">
        <div className="mb-4">
          <Link to="/" className="btn mb-2">
            <ArrowLeft style={{ marginRight: '8px' }} />
            Ana Sayfaya D√∂n
          </Link>
          <h1 className="module-header">
            <Headphones />
            Listening Mod√ºl√º
          </h1>
        </div>

        {/* Ayarlar */}
        <div className="card mb-4">
          <h3>‚öôÔ∏è Ayarlar</h3>
          <div className="grid" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))' }}>
            <div>
              <label>Konu:</label>
              <select 
                value={selectedTopic} 
                onChange={(e) => setSelectedTopic(e.target.value)}
                className="form-control"
              >
                {topics.map(topic => (
                  <option key={topic} value={topic}>{topic}</option>
                ))}
              </select>
            </div>
            <div>
              <label>Zorluk:</label>
              <select 
                value={selectedDifficulty} 
                onChange={(e) => setSelectedDifficulty(e.target.value)}
                className="form-control"
              >
                {difficulties.map(diff => (
                  <option key={diff.value} value={diff.value}>{diff.label}</option>
                ))}
              </select>
            </div>
            <div>
              <label>Aksan (ElevenLabs TTS):</label>
              <select 
                value={selectedAccent} 
                onChange={(e) => setSelectedAccent(e.target.value)}
                className="form-control"
              >
                {accents.map(accent => (
                  <option key={accent.value} value={accent.value}>{accent.label}</option>
                ))}
              </select>
              <small style={{ color: '#666', fontSize: '12px' }}>
                Her aksan i√ßin √∂zel doƒüal ses kullanƒ±lƒ±r
              </small>
            </div>
          </div>
          <button 
            onClick={generateListening} 
            disabled={isGenerating}
            className="btn btn-primary mt-3"
          >
            {isGenerating ? 'Olu≈üturuluyor...' : 'üéß Yeni Listening Olu≈ütur'}
          </button>
        </div>

        {/* Listening ƒ∞√ßeriƒüi */}
        {listeningContent && !testStarted && (
          <div className="card mb-4">
            <h3>üìù IELTS Listening Test - {listeningContent.topic}</h3>
            <p><strong>Toplam S√ºre:</strong> {listeningContent.total_duration} dakika</p>
            <p><strong>Toplam Soru:</strong> {listeningContent.total_questions} soru</p>
            <p><strong>B√∂l√ºm Sayƒ±sƒ±:</strong> {listeningContent.sections.length} b√∂l√ºm</p>
            
            <div className="ielts-instructions">
              <h4>üìã Sƒ±nav Talimatlarƒ±:</h4>
              <p>{listeningContent.instructions}</p>
            </div>

            <div className="sections-overview">
              <h4>üìö B√∂l√ºmler:</h4>
              {listeningContent.sections.map((section, index) => (
                <div key={section.id} className="section-preview">
                  <h5>B√∂l√ºm {section.id}: {section.title}</h5>
                  <p>{section.description}</p>
                  <p><strong>Soru Sayƒ±sƒ±:</strong> {section.questions.length} | <strong>S√ºre:</strong> {section.duration} dakika</p>
                </div>
              ))}
            </div>

            <div className="text-center mt-4">
              <button 
                onClick={startTest}
                className="btn btn-primary"
                style={{ fontSize: '1.2rem', padding: '15px 30px' }}
              >
                üéß Sƒ±navƒ± Ba≈ülat
              </button>
            </div>
          </div>
        )}

        {/* Sƒ±nav Aray√ºz√º */}
        {listeningContent && testStarted && (
          <div className="card mb-4">
            {/* Sƒ±nav Header */}
            <div className="exam-header">
              <div className="exam-info">
                <h3>üéß IELTS Listening Test</h3>
                <p>B√∂l√ºm {currentSection + 1} / {listeningContent.sections.length}</p>
              </div>
              
              <div className="exam-controls">
                <div className="timer-display">
                  <Clock className="icon" />
                  <span className="timer-text">{formatTime(timeLeft)}</span>
                </div>
                
                <div className="control-buttons">
                  <button 
                    className="btn btn-secondary"
                    onClick={pauseTest}
                  >
                    {isPaused ? <Play className="icon" /> : <Pause className="icon" />}
                    {isPaused ? 'Devam Et' : 'Duraklat'}
                  </button>
                  
                  <button 
                    className="btn btn-danger"
                    onClick={checkAnswers}
                  >
                    Sƒ±navƒ± Bitir
                  </button>
                </div>
              </div>
            </div>

            {/* Mevcut B√∂l√ºm */}
            {listeningContent.sections[currentSection] && (
              <div className="current-section">
                <h4>B√∂l√ºm {listeningContent.sections[currentSection].id}: {listeningContent.sections[currentSection].title}</h4>
                <p>{listeningContent.sections[currentSection].description}</p>
                
                <div className="section-controls">
                  <button 
                    onClick={() => playText(listeningContent.sections[currentSection].audio_script)}
                    disabled={isGeneratingAudio}
                    className="btn btn-success"
                  >
                    {isGeneratingAudio ? (
                      <>‚è≥ Ses √ºretiliyor...</>
                    ) : isPlaying ? (
                      <><Pause /> Durdur</>
                    ) : currentAudio ? (
                      <><Play /> Devam Et</>
                    ) : (
                      <><Play /> Dinle</>
                    )}
                  </button>
                  
                  <button 
                    onClick={() => setShowTranscript(!showTranscript)}
                    className="btn"
                    style={{ 
                      padding: '5px 15px', 
                      fontSize: '12px',
                      background: showTranscript ? '#dc3545' : '#007bff',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer'
                    }}
                  >
                    {showTranscript ? 'üëÅÔ∏è Gizle' : 'üëÅÔ∏è G√∂ster'}
                  </button>
                </div>

                {showTranscript && (
                  <div className="transcript">
                    <h5>üìÑ Metin:</h5>
                    <div className="transcript-content">
                      {listeningContent.sections[currentSection].audio_script}
                    </div>
                  </div>
                )}

                {/* B√∂l√ºm Sorularƒ± */}
                <div className="section-questions">
                  <h5>‚ùì Sorular:</h5>
                  {listeningContent.sections[currentSection].questions.map((question, index) => (
                    <div key={question.id} className="question-item">
                      <p><strong>{index + 1}. {question.question}</strong></p>
                      
                      {/* Multiple Choice Sorular */}
                      {question.type === 'multiple_choice' && question.options && (
                        <div>
                          {question.options.map((option, optionIndex) => (
                            <label key={optionIndex} className="option-label">
                              <input
                                type="radio"
                                name={`question-${question.id}`}
                                value={optionIndex}
                                checked={userAnswers[question.id] === optionIndex}
                                onChange={() => handleAnswerSelect(question.id, optionIndex)}
                              />
                              {String.fromCharCode(65 + optionIndex)}. {option}
                            </label>
                          ))}
                        </div>
                      )}

                      {/* Bo≈üluk Doldurma Sorular */}
                      {(question.type === 'fill_in_blank' || question.type === 'form_completion' || 
                        question.type === 'note_completion' || question.type === 'sentence_completion') && (
                        <div>
                          <input
                            type="text"
                            value={typeof userAnswers[question.id] === 'string' ? userAnswers[question.id] as string : ''}
                            onChange={(e) => handleAnswerSelect(question.id, e.target.value)}
                            placeholder={`Cevabƒ±nƒ±zƒ± yazƒ±n${question.word_limit ? ` (max ${question.word_limit} kelime)` : ''}...`}
                            className="answer-input"
                          />
                        </div>
                      )}

                      {/* Doƒüru/Yanlƒ±≈ü Sorular */}
                      {question.type === 'true_false' && (
                        <div>
                          <label className="option-label">
                            <input
                              type="radio"
                              name={`question-${question.id}`}
                              value="true"
                              checked={userAnswers[question.id] === true}
                              onChange={() => handleAnswerSelect(question.id, true)}
                            />
                            True (Doƒüru)
                          </label>
                          <label className="option-label">
                            <input
                              type="radio"
                              name={`question-${question.id}`}
                              value="false"
                              checked={userAnswers[question.id] === false}
                              onChange={() => handleAnswerSelect(question.id, false)}
                            />
                            False (Yanlƒ±≈ü)
                          </label>
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                {/* B√∂l√ºm Navigasyonu */}
                <div className="section-navigation">
                  <button 
                    className="btn btn-secondary"
                    onClick={prevSection}
                    disabled={currentSection === 0}
                  >
                    ‚Üê √ñnceki B√∂l√ºm
                  </button>
                  
                  <span className="section-indicator">
                    B√∂l√ºm {currentSection + 1} / {listeningContent.sections.length}
                  </span>
                  
                  <button 
                    className="btn btn-primary"
                    onClick={nextSection}
                    disabled={currentSection === listeningContent.sections.length - 1}
                  >
                    Sonraki B√∂l√ºm ‚Üí
                  </button>
                </div>
              </div>
            )}
          </div>
        )}


        {/* √ñrnek ƒ∞√ßerik */}
        {!listeningContent && (
          <div className="card">
            <h3>üéß Nasƒ±l √áalƒ±≈üƒ±r?</h3>
            <ol>
              <li>Yukarƒ±daki ayarlardan konu, zorluk ve aksan se√ßin</li>
              <li>"Yeni Listening Olu≈ütur" butonuna tƒ±klayƒ±n</li>
              <li>AI tarafƒ±ndan olu≈üturulan metni dinleyin (metin ba≈üta gizli)</li>
              <li>ƒ∞stersen "G√∂ster" butonuyla metni g√∂r√ºnt√ºleyebilirsin</li>
              <li>Sorularƒ± cevaplayƒ±n</li>
              <li>Sonu√ßlarƒ±nƒ±zƒ± g√∂r√ºn</li>
            </ol>
            <div style={{ 
              backgroundColor: '#e7f3ff', 
              padding: '15px', 
              borderRadius: '8px', 
              marginTop: '15px',
              border: '1px solid #b3d9ff'
            }}>
              <h4 style={{ margin: '0 0 10px 0', color: '#0066cc' }}>üí° ƒ∞pu√ßlarƒ±:</h4>
              <ul style={{ margin: 0, paddingLeft: '20px' }}>
                <li>Metin ba≈üta gizli - ger√ßek IELTS gibi dinle</li>
                <li>Durdur/Devam Et ile istediƒüin zaman kontrol et</li>
                <li>Farklƒ± aksanlarƒ± dene - ger√ßek sƒ±navda kar≈üƒ±la≈üabilirsin</li>
                <li>√áoklu soru tipleri: √áoktan se√ßmeli, bo≈üluk doldurma, doƒüru/yanlƒ±≈ü</li>
                <li>Bo≈üluk doldurma i√ßin b√ºy√ºk/k√º√ß√ºk harf √∂nemli deƒüil</li>
              </ul>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default ListeningModule;

